import{aE as k,_ as q}from"./index-B2urM1q-.js";import D from"./BasicInfoSection-L7RY7lqL.js";import{_ as B}from"./TriggerSection.vue_vue_type_script_setup_true_lang-HdTB0MaC.js";import{_ as G}from"./ActionSection.vue_vue_type_script_setup_true_lang-tghRK68_.js";import{R as h}from"./index-DVRAvb-D.js";import{o as L,p as f,q as p}from"./constants-D46CCSyK.js";import{C as y}from"./constants-C3gLHYOK.js";import{aH as N,h as U,f as j,M as _}from"./form-designer-DHHJWkD5.js";import{l as Y,r as m,j as F,c as K,b as C,A as M,q as z,u as t,h as $,B as v,J as n,x as H,G as A,n as J}from"./form-create-_84fGzaM.js";const Q={class:"drawer-footer"},W=Y({name:"RuleSceneForm",__name:"RuleSceneForm",props:{modelValue:{type:Boolean},ruleScene:{}},emits:["update:modelValue","success"],setup(O,{emit:T}){const l=O,R=T,u=k(l,"modelValue",R),w=()=>({name:"",description:"",status:y.ENABLE,triggers:[{type:f.DEVICE_PROPERTY_POST,productId:void 0,deviceId:void 0,identifier:void 0,operator:void 0,value:void 0,cronExpression:void 0,conditionGroups:[]}],actions:[]}),g=m(),a=m(w()),I=F({name:[{required:!0,message:"\u573A\u666F\u540D\u79F0\u4E0D\u80FD\u4E3A\u7A7A",trigger:"blur"},{type:"string",min:1,max:50,message:"\u573A\u666F\u540D\u79F0\u957F\u5EA6\u5E94\u57281-50\u4E2A\u5B57\u7B26\u4E4B\u95F4",trigger:"blur"}],status:[{required:!0,message:"\u573A\u666F\u72B6\u6001\u4E0D\u80FD\u4E3A\u7A7A",trigger:"change"},{type:"enum",enum:[y.ENABLE,y.DISABLE],message:"\u72B6\u6001\u503C\u5FC5\u987B\u4E3A\u542F\u7528\u6216\u7981\u7528",trigger:"change"}],description:[{type:"string",max:200,message:"\u573A\u666F\u63CF\u8FF0\u4E0D\u80FD\u8D85\u8FC7200\u4E2A\u5B57\u7B26",trigger:"blur"}],triggers:[{required:!0,validator:(s,e,o)=>{if(e&&Array.isArray(e)&&e.length!==0){for(let i=0;i<e.length;i++){const r=e[i];if(!r.type)return void o(new Error(`\u89E6\u53D1\u5668 ${i+1}: \u89E6\u53D1\u5668\u7C7B\u578B\u4E0D\u80FD\u4E3A\u7A7A`));if(L(r.type)){if(!r.productId)return void o(new Error(`\u89E6\u53D1\u5668 ${i+1}: \u4EA7\u54C1\u4E0D\u80FD\u4E3A\u7A7A`));if(!r.deviceId)return void o(new Error(`\u89E6\u53D1\u5668 ${i+1}: \u8BBE\u5907\u4E0D\u80FD\u4E3A\u7A7A`));if(!r.identifier)return void o(new Error(`\u89E6\u53D1\u5668 ${i+1}: \u7269\u6A21\u578B\u6807\u8BC6\u7B26\u4E0D\u80FD\u4E3A\u7A7A`));if(!r.operator)return void o(new Error(`\u89E6\u53D1\u5668 ${i+1}: \u64CD\u4F5C\u7B26\u4E0D\u80FD\u4E3A\u7A7A`));if(r.value===void 0||r.value===null||r.value==="")return void o(new Error(`\u89E6\u53D1\u5668 ${i+1}: \u53C2\u6570\u503C\u4E0D\u80FD\u4E3A\u7A7A`))}if(r.type===f.TIMER&&!r.cronExpression)return void o(new Error(`\u89E6\u53D1\u5668 ${i+1}: CRON\u8868\u8FBE\u5F0F\u4E0D\u80FD\u4E3A\u7A7A`))}o()}else o(new Error("\u81F3\u5C11\u9700\u8981\u4E00\u4E2A\u89E6\u53D1\u5668"))},trigger:"change"}],actions:[{required:!0,validator:(s,e,o)=>{if(e&&Array.isArray(e)&&e.length!==0){for(let i=0;i<e.length;i++){const r=e[i];if(!r.type)return void o(new Error(`\u6267\u884C\u5668 ${i+1}: \u6267\u884C\u5668\u7C7B\u578B\u4E0D\u80FD\u4E3A\u7A7A`));if(r.type===p.DEVICE_PROPERTY_SET||r.type===p.DEVICE_SERVICE_INVOKE){if(!r.productId)return void o(new Error(`\u6267\u884C\u5668 ${i+1}: \u4EA7\u54C1\u4E0D\u80FD\u4E3A\u7A7A`));if(!r.deviceId)return void o(new Error(`\u6267\u884C\u5668 ${i+1}: \u8BBE\u5907\u4E0D\u80FD\u4E3A\u7A7A`));if(r.type===p.DEVICE_SERVICE_INVOKE&&!r.identifier)return void o(new Error(`\u6267\u884C\u5668 ${i+1}: \u670D\u52A1\u4E0D\u80FD\u4E3A\u7A7A`));if(!r.params||Object.keys(r.params).length===0)return void o(new Error(`\u6267\u884C\u5668 ${i+1}: \u53C2\u6570\u914D\u7F6E\u4E0D\u80FD\u4E3A\u7A7A`))}if((r.type===p.ALERT_TRIGGER||r.type===p.ALERT_RECOVER)&&!r.alertConfigId)return void o(new Error(`\u6267\u884C\u5668 ${i+1}: \u544A\u8B66\u914D\u7F6E\u4E0D\u80FD\u4E3A\u7A7A`))}o()}else o(new Error("\u81F3\u5C11\u9700\u8981\u4E00\u4E2A\u6267\u884C\u5668"))},trigger:"change"}]}),E=m(!1),c=m(!1),b=K(()=>c.value?"\u7F16\u8F91\u573A\u666F\u8054\u52A8\u89C4\u5219":"\u65B0\u589E\u573A\u666F\u8054\u52A8\u89C4\u5219"),x=async()=>{if(g.value&&await g.value.validate()){E.value=!0;try{c.value?(await h.updateRuleScene(a.value),_.success("\u66F4\u65B0\u6210\u529F")):(await h.createRuleScene(a.value),_.success("\u521B\u5EFA\u6210\u529F")),u.value=!1,R("success")}catch{_.error(c.value?"\u66F4\u65B0\u5931\u8D25":"\u521B\u5EFA\u5931\u8D25")}finally{E.value=!1}}},V=()=>{u.value=!1},S=()=>{var s;l.ruleScene?(c.value=!0,a.value={...l.ruleScene,triggers:(s=l.ruleScene.triggers)!=null&&s.length?l.ruleScene.triggers:[{type:f.DEVICE_PROPERTY_POST,productId:void 0,deviceId:void 0,identifier:void 0,operator:void 0,value:void 0,cronExpression:void 0,conditionGroups:[]}],actions:l.ruleScene.actions||[]}):(c.value=!1,a.value=w())};return C(u,async s=>{var e;s&&(S(),await J(),(e=g.value)==null||e.clearValidate())}),C(()=>l.ruleScene,()=>{u.value&&S()},{deep:!0}),(s,e)=>{const o=U,i=q,r=j,P=N;return z(),M(P,{modelValue:t(u),"onUpdate:modelValue":e[3]||(e[3]=d=>$(u)?u.value=d:null),title:t(b),size:"80%",direction:"rtl","close-on-click-modal":!1,"close-on-press-escape":!1,onClose:V},{footer:v(()=>[H("div",Q,[n(r,{disabled:t(E),type:"primary",onClick:x},{default:v(()=>[n(i,{icon:"ep:check"}),e[4]||(e[4]=A(" \u786E \u5B9A "))]),_:1},8,["disabled"]),n(r,{onClick:V},{default:v(()=>[n(i,{icon:"ep:close"}),e[5]||(e[5]=A(" \u53D6 \u6D88 "))]),_:1})])]),default:v(()=>[n(o,{ref_key:"formRef",ref:g,model:t(a),rules:t(I),"label-width":"110px"},{default:v(()=>[n(D,{modelValue:t(a),"onUpdate:modelValue":e[0]||(e[0]=d=>$(a)?a.value=d:null),rules:t(I)},null,8,["modelValue","rules"]),n(B,{triggers:t(a).triggers,"onUpdate:triggers":e[1]||(e[1]=d=>t(a).triggers=d)},null,8,["triggers"]),n(G,{actions:t(a).actions,"onUpdate:actions":e[2]||(e[2]=d=>t(a).actions=d)},null,8,["actions"])]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title"])}}});export{W as _};
