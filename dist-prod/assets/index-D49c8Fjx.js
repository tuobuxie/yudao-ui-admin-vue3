import{e as ge,d as Ce,_ as _e}from"./index-DzK2S43K.js";import{l as be,r as l,c as ke,e as Te,A as C,q as y,B as m,J as n,u as t,x as f,m as ee,E as h,G as H,H as J,C as Ie,h as E,a8 as Ue,n as N}from"./form-create-_84fGzaM.js";import{C as G}from"./index-H5W3Tj9_.js";import{C as Oe}from"./index-DYHyZbxo.js";import{_ as Ve}from"./ConversationList.vue_vue_type_script_setup_true_lang-BWmEWTHa.js";import{_ as ze}from"./ConversationUpdateForm.vue_vue_type_script_setup_true_lang-B2U_tBuu.js";import{_ as De}from"./MessageList.vue_vue_type_script_setup_true_lang-B5ISxvci.js";import{_ as Me}from"./MessageListEmpty.vue_vue_type_script_setup_true_lang-CtsX5HOi.js";import Ee from"./MessageLoading-Cl1ghPWa.js";import{_ as Se}from"./MessageNewConversation.vue_vue_type_script_setup_true_lang-D29Xy7Kq.js";import je from"./MessageFileUpload-DbplaHiV.js";import{U as Ae,W as Le,f as Re,X as Be,aa as qe,D as He}from"./form-designer-DHHJWkD5.js";import"./fetch-D5K_4anA.js";import"./RoleRepository.vue_vue_type_style_index_0_lang-w7KuQz2n.js";import"./RoleList.vue_vue_type_script_setup_true_lang-V-8ZTnha.js";import"./ChatRoleForm.vue_vue_type_script_setup_true_lang-B3vlu6sN.js";import"./Dialog.vue_vue_type_style_index_0_lang-D3YOFsHs.js";import"./constants-C3gLHYOK.js";import"./index-DoOta60q.js";import"./constants-CHvLs4wt.js";import"./index-CbDrSz2V.js";import"./index-BQmqFZO8.js";import"./RoleCategoryList.vue_vue_type_script_setup_true_lang-v3mP__6e.js";import"./tagsView-CKM4YfGJ.js";import"./gpt-WhTktY3S.js";import"./formatTime-BGPGB_ys.js";import"./MessageReasoning-BTfXvaVF.js";import"./index-CY7R6inO.js";import"./index-DWAKVBMX.js";import"./MessageKnowledge.vue_vue_type_script_setup_true_lang-C7hE13Uu.js";import"./MessageFiles.vue_vue_type_script_setup_true_lang-BTZtHKCY.js";import"./file-DDqGaN1G.js";import"./MessageWebSearch-CZrP-37t.js";import"./avatar-BG6NdH5s.js";const Je={class:"text-18px font-bold"},Ne={key:0},Ge={key:0,class:"flex w-300px flex-row justify-end"},Ke=["innerHTML"],Fe={class:"absolute top-0 bottom-0 left-0 right-0 overflow-y-hidden p-0 m-0"},Pe={class:"mt-10px mx-20px mb-20px py-9px px-10px flex flex-col h-auto rounded-10px",style:{border:"1px solid var(--el-border-color)"}},We={class:"flex justify-between pb-0 pt-5px"},Xe={class:"flex items-center"},$e=be({name:"AiChat",__name:"index",setup(Qe){const K=ge(),x=Ce(),F=l(),r=l(null),u=l(null),i=l(!1),U=l(),o=l([]),_=l(!1),S=l(),k=l(50),j=l(!1),b=l(!1),O=l(),A=l(),d=l(),V=l(!0),z=l(!1),w=l([]),g=l(""),D=l(""),P=async e=>{if(!e)return;const a=await Oe.getChatConversationMy(e);a&&(u.value=a,r.value=a.id)},ae=async e=>i.value?(x.alert("\u5BF9\u8BDD\u4E2D\uFF0C\u4E0D\u5141\u8BB8\u5207\u6362!"),!1):(r.value=e.id,u.value=e,await L(),T(!0),d.value="",w.value=[],!0),te=async e=>{r.value===e.id&&await W()},W=async()=>{if(i.value)return x.alert("\u5BF9\u8BDD\u4E2D\uFF0C\u4E0D\u5141\u8BB8\u5207\u6362!"),!1;r.value=null,u.value=null,o.value=[]},X=l(),le=async()=>{X.value.open(r.value)},oe=async()=>{await P(r.value)},ne=async()=>{await F.value.createConversation()},re=async()=>{d.value="",w.value=[]},L=async()=>{try{if(r.value===null)return;S.value=setTimeout(()=>{_.value=!0},60),o.value=await G.getChatMessageListByConversationId(r.value),await N(),await T()}finally{S.value&&clearTimeout(S.value),_.value=!1}},R=ke(()=>{var e;return o.value.length>0?o.value:(e=u.value)!=null&&e.systemMessage?[{id:0,conversationId:u.value.id||0,type:"system",userId:"",roleId:"",model:0,modelId:0,content:u.value.systemMessage,tokens:0,createTime:new Date,roleAvatar:"",userAvatar:""}]:[]}),se=()=>{i.value?x.alert("\u56DE\u7B54\u4E2D\uFF0C\u4E0D\u80FD\u5220\u9664!"):L()},ue=async()=>{if(r.value)try{await x.delConfirm("\u786E\u8BA4\u6E05\u7A7A\u5BF9\u8BDD\u6D88\u606F\uFF1F"),await G.deleteByConversationId(r.value),o.value=[]}catch{}},ie=()=>{U.value.handlerGoTop()},ve=async e=>{var s;if(b.value||i.value)return;const a=(s=d.value)==null?void 0:s.trim();e.key==="Enter"&&(e.shiftKey?(d.value+=`\r
`,e.preventDefault()):(await M(a),e.preventDefault()))},ce=()=>{var e;M((e=d.value)==null?void 0:e.trim())},pe=e=>{if(!b.value){if(e.data==null)return;b.value=!0}A.value&&clearTimeout(A.value),A.value=setTimeout(()=>{b.value=!1},400)},me=()=>{b.value=!0},de=()=>{setTimeout(()=>{b.value=!1},200)},M=async e=>{if(e.length<1)return void x.error("\u53D1\u9001\u5931\u8D25\uFF0C\u539F\u56E0\uFF1A\u5185\u5BB9\u4E3A\u7A7A\uFF01");if(r.value==null)return void x.error("\u8FD8\u6CA1\u521B\u5EFA\u5BF9\u8BDD\uFF0C\u4E0D\u80FD\u53D1\u9001!");const a=[...w.value];d.value="",w.value=[],await fe({conversationId:r.value,content:e,attachmentUrls:a})},fe=async e=>{O.value=new AbortController,i.value=!0,g.value="";try{o.value.push({id:-1,conversationId:r.value,type:"user",content:e.content,attachmentUrls:e.attachmentUrls||[],createTime:new Date}),o.value.push({id:-2,conversationId:r.value,type:"assistant",content:"\u601D\u8003\u4E2D...",reasoningContent:"",createTime:new Date}),await N(),await T(),he();let a=!0;await G.sendChatMessageStream(e.conversationId,e.content,O.value,V.value,z.value,async s=>{const{code:v,data:c,msg:q}=JSON.parse(s.data);if(v!==0)return x.alert(`\u5BF9\u8BDD\u5F02\u5E38! ${q}`),void(g.value===""&&o.value.pop());if(c.receive.content!==""||c.receive.reasoningContent){if(a&&(a=!1,o.value.pop(),o.value.pop(),o.value.push(c.send),c.send.attachmentUrls=e.attachmentUrls,o.value.push(c.receive)),c.receive.reasoningContent){const I=o.value[o.value.length-1];I.reasoningContent=I.reasoningContent+c.receive.reasoningContent}c.receive.content!==""&&(g.value=g.value+c.receive.content),await T()}},s=>{throw x.alert("\u5BF9\u8BDD\u5F02\u5E38\uFF01"),B(),s},()=>{B()},e.attachmentUrls)}catch{}},B=async()=>{O.value&&O.value.abort(),i.value=!1},ye=e=>{d.value=e.content},xe=e=>{M(e.content)},T=async e=>{await N(),U.value&&U.value.scrollToBottom(e)},he=async()=>{let e=0;try{if(j.value)return;j.value=!0,D.value="";const a=async()=>{const v=(g.value.length-D.value.length)/10;k.value=v>5?10:v>2?30:v>1.5?50:100,i.value||(k.value=10),e<g.value.length?(D.value+=g.value[e],e++,o.value[o.value.length-1].content=D.value,await T(),s=setTimeout(a,k.value)):i.value?s=setTimeout(a,k.value):(j.value=!1,clearTimeout(s))};let s=setTimeout(a,k.value)}catch{}};return Te(async()=>{if(K.query.conversationId){const e=K.query.conversationId;r.value=e,await P(e)}_.value=!0,await L()}),(e,a)=>{const s=_e,v=Re,c=Le,q=Be,I=He,we=qe,$=Ae;return y(),C($,{class:"absolute flex-1 top-0 left-0 h-full w-full"},{default:m(()=>{var Q;return[n(Ve,{"active-id":((Q=t(r))==null?void 0:Q.toString())||"",ref_key:"conversationListRef",ref:F,onOnConversationCreate:re,onOnConversationClick:ae,onOnConversationClear:W,onOnConversationDelete:te},null,8,["active-id"]),n($,{class:"bg-[var(--el-bg-color)]"},{default:m(()=>[n(c,{class:"flex flex-row items-center justify-between bg-[var(--el-bg-color-page)] shadow-[0_0_0_0_var(--el-border-color-light)]"},{default:m(()=>{var p,Y;return[f("div",Je,[H(J((p=t(u))!=null&&p.title?(Y=t(u))==null?void 0:Y.title:"\u5BF9\u8BDD")+" ",1),t(o).length?(y(),ee("span",Ne,"("+J(t(o).length)+")",1)):h("",!0)]),t(u)?(y(),ee("div",Ge,[n(v,{type:"primary",bg:"",plain:"",size:"small",onClick:le},{default:m(()=>{var Z;return[f("span",{innerHTML:(Z=t(u))==null?void 0:Z.modelName},null,8,Ke),n(s,{icon:"ep:setting",class:"ml-10px"})]}),_:1}),n(v,{size:"small",class:"p-10px",onClick:ue},{default:m(()=>[n(s,{icon:"heroicons-outline:archive-box-x-mark",color:"var(--el-text-color-placeholder)"})]),_:1}),n(v,{size:"small",class:"p-10px"},{default:m(()=>[n(s,{icon:"ep:download",color:"var(--el-text-color-placeholder)"})]),_:1}),n(v,{size:"small",class:"p-10px",onClick:ie},{default:m(()=>[n(s,{icon:"ep:top",color:"var(--el-text-color-placeholder)"})]),_:1})])):h("",!0)]}),_:1}),n(q,{class:"m-0 p-0 relative h-full w-full"},{default:m(()=>[f("div",null,[f("div",Fe,[t(_)?(y(),C(Ee,{key:0})):h("",!0),t(u)?h("",!0):(y(),C(Se,{key:1,onOnNewConversation:ne})),!t(_)&&t(R).length===0&&t(u)?(y(),C(Me,{key:2,onOnPrompt:M})):h("",!0),!t(_)&&t(R).length>0&&t(u)?(y(),C(De,{key:3,ref_key:"messageRef",ref:U,conversation:t(u),list:t(R),onOnDeleteSuccess:se,onOnEdit:ye,onOnRefresh:xe},null,8,["conversation","list"])):h("",!0)])])]),_:1}),n(we,{class:"flex flex-col !h-auto !p-0"},{default:m(()=>[f("form",Pe,[Ie(f("textarea",{class:"h-80px border-none box-border resize-none py-0 px-2px overflow-auto focus:outline-none","onUpdate:modelValue":a[0]||(a[0]=p=>E(d)?d.value=p:null),onKeydown:ve,onInput:pe,onCompositionstart:me,onCompositionend:de,placeholder:"\u95EE\u6211\u4EFB\u4F55\u95EE\u9898...\uFF08Shift+Enter \u6362\u884C\uFF0C\u6309\u4E0B Enter \u53D1\u9001\uFF09"},"          ",544),[[Ue,t(d)]]),f("div",We,[f("div",Xe,[n(je,{modelValue:t(w),"onUpdate:modelValue":a[1]||(a[1]=p=>E(w)?w.value=p:null),limit:5,"max-size":10,class:"mr-10px"},null,8,["modelValue"]),n(I,{modelValue:t(V),"onUpdate:modelValue":a[2]||(a[2]=p=>E(V)?V.value=p:null)},null,8,["modelValue"]),a[5]||(a[5]=f("span",{class:"ml-5px mr-15px text-14px text-#8f8f8f"},"\u4E0A\u4E0B\u6587",-1)),n(I,{modelValue:t(z),"onUpdate:modelValue":a[3]||(a[3]=p=>E(z)?z.value=p:null)},null,8,["modelValue"]),a[6]||(a[6]=f("span",{class:"ml-5px text-14px text-#8f8f8f"},"\u8054\u7F51\u641C\u7D22",-1))]),t(i)==0?(y(),C(v,{key:0,type:"primary",size:"default",onClick:ce,loading:t(i)},{default:m(()=>[H(J(t(i)?"\u8FDB\u884C\u4E2D":"\u53D1\u9001"),1)]),_:1},8,["loading"])):h("",!0),t(i)==1?(y(),C(v,{key:1,type:"danger",size:"default",onClick:a[4]||(a[4]=p=>B())},{default:m(()=>a[7]||(a[7]=[H(" \u505C\u6B62 ")])),_:1})):h("",!0)])])]),_:1})]),_:1}),n(ze,{ref_key:"conversationUpdateFormRef",ref:X,onSuccess:oe},null,512)]}),_:1})}}});export{$e as default};
