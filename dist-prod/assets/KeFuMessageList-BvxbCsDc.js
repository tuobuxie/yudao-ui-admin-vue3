import{X as J,d as de,aF as me,N as P,_ as pe,c as fe}from"./index-DzK2S43K.js";import{l as ve,r as v,j as ye,c as O,u as s,aa as he,ag as Te,A as I,q as d,B as p,J as o,x as N,H as V,C as Z,m as K,E as h,I as ge,$ as we,D as z,K as xe,Z as ke,N as Me,h as _e,n as Ee}from"./form-create-_84fGzaM.js";import{_ as Ie}from"./EmojiSelectPopover.vue_vue_type_script_setup_true_lang-K1oCb-1m.js";import{_ as Ne}from"./PictureSelectUpload.vue_vue_type_script_setup_true_lang-SOvOQfQA.js";import Se from"./ProductItem-B1yiaH0B.js";import Ue from"./OrderItem-CsXxFSx8.js";import{u as be}from"./emoji-D7Hrusa8.js";import{u as Re,K as T}from"./kefu-CUNTI8lW.js";import{U as X}from"./constants-C3gLHYOK.js";import{f as Q}from"./formatTime-BGPGB_ys.js";import{a as Ke,ax as $,as as Ae,U as Ce,W as je,e as Be,ah as He,al as Le,X as Oe,k as Xe,aa as De,aU as Fe}from"./form-designer-DHHJWkD5.js";import"./picture-CTjip5lJ.js";const Je=async m=>await J.post({url:"/promotion/kefu-message/send",data:m}),Pe=async m=>await J.put({url:"/promotion/kefu-message/update-read-status?conversationId="+m}),Ve=async m=>await J.get({url:"/promotion/kefu-message/list",params:m});var $e={exports:{}};const Ge=Ke($e.exports=function(m,D,i){m=m||{};var g=D.prototype,j={future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"};function u(r,l,k,M){return g.fromToBase(r,l,k,M)}i.en.relativeTime=j,g.fromToBase=function(r,l,k,M,S){for(var c,_,U,A=k.$locale().relativeTime||j,w=m.thresholds||[{l:"s",r:44,d:"second"},{l:"m",r:89},{l:"mm",r:44,d:"minute"},{l:"h",r:89},{l:"hh",r:21,d:"hour"},{l:"d",r:35},{l:"dd",r:25,d:"day"},{l:"M",r:45},{l:"MM",r:10,d:"month"},{l:"y",r:17},{l:"yy",d:"year"}],F=w.length,y=0;y<F;y+=1){var f=w[y];f.d&&(c=M?i(r).diff(k,f.d,!0):k.diff(r,f.d,!0));var x=(m.rounding||Math.round)(Math.abs(c));if(U=c>0,x<=f.r||!f.r){x<=1&&y>0&&(f=w[y-1]);var C=A[f.l];S&&(x=S(""+x)),_=typeof C=="string"?C.replace("%d",x):C(x,l,f.l,U);break}}if(l)return _;var b=U?A.future:A.past;return typeof b=="function"?b(_):b.replace("%s",_)},g.to=function(r,l){return u(r,l,this,!0)},g.from=function(r,l){return u(r,l,this)};var n=function(r){return r.$u?i.utc():i()};g.toNow=function(r){return this.to(n(this),r)},g.fromNow=function(r){return this.from(n(this),r)}}),We={class:"kefu-title"},Ye={class:"flex justify-center items-center mb-20px"},qe={key:0,class:"date-message"},Ze={key:1,class:"system-message"},ze={key:0,class:"line-height-normal text-justify h-1/1 w-full"},Qe={class:"chat-tools flex items-center"},ea=fe(ve({name:"KeFuMessageList",__name:"KeFuMessageList",setup(m,{expose:D}){$.extend(Ge);const i=v(""),{replaceEmoji:g}=be(),j=de(),u=v([]),n=v({}),r=v(!1),l=ye({conversationId:0,createTime:void 0}),k=v(0),M=v(!1),S=Re(),c=O(()=>e=>me(e.content)),_=async()=>{const e=await Ve(l);if(P(e))y.value=!0;else{if(l.createTime=Q(e.at(-1).createTime),l.createTime)for(const t of e)U(t);else u.value=e;M.value=!0}},U=e=>{u.value.some(t=>t.id===e.id)||u.value.push(e)},A=O(()=>(u.value.sort((e,t)=>e.createTime-t.createTime),u.value)),w=async e=>{if(n.value){if(e!==void 0){if(e.conversationId!==n.value.id)return;U(e)}else l.createTime=void 0,await _();R.value?r.value=!0:await G()}};D({getNewMessageList:async e=>{S.saveMessageList(n.value.id,u.value),u.value=S.getConversationMessageList(e.id)||[],k.value=u.value.length||0,R.value=!1,M.value=!1,y.value=!1,n.value=e,l.conversationId=e.id,l.createTime=void 0,await w()},refreshMessageList:w});const F=O(()=>!P(n.value)),y=v(!1),f=e=>{i.value+=e.name},x=async e=>{const t={conversationId:n.value.id,contentType:T.IMAGE,content:JSON.stringify({picUrl:e})};await b(t)},C=async e=>{var E;if(e.shiftKey)return;if(P((E=s(i.value))==null?void 0:E.trim()))return j.notifyWarning("\u8BF7\u8F93\u5165\u6D88\u606F\u540E\u518D\u53D1\u9001\u54E6\uFF01"),void(i.value="");const t={conversationId:n.value.id,contentType:T.TEXT,content:JSON.stringify({text:i.value})};await b(t)},b=async e=>{await Je(e),i.value="",await w(),await S.updateConversation(n.value.id)},B=v(),H=v(),G=async()=>{R.value=!1,await(async()=>{R.value||(await Ee(),H.value.setScrollTop(B.value.clientHeight),r.value=!1,await Pe(n.value.id))})()},R=v(!1),ee=Ae(({scrollTop:e})=>{var E;if(y.value)return;Math.floor(e)===0&&ae();const t=(E=H.value)==null?void 0:E.wrapRef;Math.abs(t.scrollHeight-t.clientHeight-t.scrollTop)<1&&(R.value=!1,w())},200),ae=async()=>{var t;const e=(t=B.value)==null?void 0:t.clientHeight;e&&(R.value=!0,await _(),H.value.setScrollTop(B.value.clientHeight-e))},se=O(()=>(e,t)=>s(u.value)[t+1]?$(s(u.value)[t+1].createTime).fromNow()!==$(s(e).createTime).fromNow():!1);return(e,t)=>{const E=je,W=He,L=he("MessageItem"),te=Le,re=Be,le=pe,Y=Oe,ne=Xe,oe=De,q=Ce,ie=Fe,ue=Te("dompurify-html");return s(F)?(d(),I(q,{key:0,class:"kefu"},{default:p(()=>[o(E,{class:"kefu-header"},{default:p(()=>[N("div",We,V(s(n).userNickname),1)]),_:1}),o(Y,{class:"kefu-content overflow-visible"},{default:p(()=>[o(re,{ref_key:"scrollbarRef",ref:H,always:"",onScroll:s(ee)},{default:p(()=>[s(M)?(d(),K("div",{key:0,ref_key:"innerRef",ref:B,class:"w-[100%] px-10px"},[(d(!0),K(ge,null,we(s(A),(a,ce)=>(d(),K("div",{key:a.id,class:"w-[100%]"},[N("div",Ye,[a.contentType!==s(T).SYSTEM&&s(se)(a,ce)?(d(),K("div",qe,V(s(Q)(a.createTime)),1)):h("",!0),a.contentType===s(T).SYSTEM?(d(),K("div",Ze,V(a.content),1)):h("",!0)]),N("div",{class:z([[a.senderType===s(X).MEMBER?"ss-row-left":a.senderType===s(X).ADMIN?"ss-row-right":""],"flex mb-20px w-[100%]"])},[a.senderType===s(X).MEMBER?(d(),I(W,{key:0,src:s(n).userAvatar,alt:"avatar",class:"w-60px h-60px"},null,8,["src"])):h("",!0),N("div",{class:z({"kefu-message":s(T).TEXT===a.contentType})},[o(L,{message:a},{default:p(()=>[s(T).TEXT===a.contentType?Z((d(),K("div",ze,null,512)),[[ue,s(g)(s(c)(a).text||a.content)]]):h("",!0)]),_:2},1032,["message"]),o(L,{message:a},{default:p(()=>[s(T).IMAGE===a.contentType?(d(),I(te,{key:0,"initial-index":0,"preview-src-list":[s(c)(a).picUrl||a.content],src:s(c)(a).picUrl||a.content,class:"w-200px mx-10px",fit:"contain","preview-teleported":""},null,8,["preview-src-list","src"])):h("",!0)]),_:2},1032,["message"]),o(L,{message:a},{default:p(()=>[s(T).PRODUCT===a.contentType?(d(),I(Se,{key:0,picUrl:s(c)(a).picUrl,price:s(c)(a).price,"sales-count":s(c)(a).salesCount,spuId:s(c)(a).spuId,stock:s(c)(a).stock,title:s(c)(a).spuName,class:"max-w-300px mx-10px"},null,8,["picUrl","price","sales-count","spuId","stock","title"])):h("",!0)]),_:2},1032,["message"]),o(L,{message:a},{default:p(()=>[s(T).ORDER===a.contentType?(d(),I(Ue,{key:0,message:a,class:"max-w-100% mx-10px"},null,8,["message"])):h("",!0)]),_:2},1032,["message"])],2),a.senderType===s(X).ADMIN?(d(),I(W,{key:1,src:a.senderAvatar,alt:"avatar"},null,8,["src"])):h("",!0)],2)]))),128))],512)):h("",!0)]),_:1},8,["onScroll"]),Z(N("div",{class:"newMessageTip flex items-center cursor-pointer",onClick:G},[t[1]||(t[1]=N("span",null,"\u6709\u65B0\u6D88\u606F",-1)),o(le,{class:"ml-5px",icon:"ep:bottom"})],512),[[xe,s(r)]])]),_:1}),o(oe,{class:"kefu-footer"},{default:p(()=>[N("div",Qe,[o(Ie,{onSelectEmoji:f}),o(Ne,{class:"ml-15px mt-3px cursor-pointer",onSendPicture:x})]),o(ne,{modelValue:s(i),"onUpdate:modelValue":t[0]||(t[0]=a=>_e(i)?i.value=a:null),rows:6,placeholder:"\u8F93\u5165\u6D88\u606F\uFF0CEnter\u53D1\u9001\uFF0CShift+Enter\u6362\u884C",style:{"border-style":"none"},type:"textarea",onKeyup:ke(Me(C,["prevent"]),["enter"])},null,8,["modelValue","onKeyup"])]),_:1})]),_:1})):(d(),I(q,{key:1,class:"kefu"},{default:p(()=>[o(Y,null,{default:p(()=>[o(ie,{description:"\u8BF7\u9009\u62E9\u5DE6\u4FA7\u7684\u4E00\u4E2A\u4F1A\u8BDD\u540E\u5F00\u59CB"})]),_:1})]),_:1}))}}}),[["__scopeId","data-v-09d2ffad"]]);export{ea as default};
