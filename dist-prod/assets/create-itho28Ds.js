import{d as I,u as L,e as M,h as J,D as P}from"./index-B2urM1q-.js";import{_ as $}from"./ContentWrap.vue_vue_type_script_setup_true_lang-BRGqERh7.js";import{c as F,g as G}from"./index-DZdFAnnW.js";import{u as Q}from"./tagsView-DIbur9wp.js";import{a as Y}from"./index-C-yhcFdr.js";import{_ as z}from"./ProcessInstanceTimeline.vue_vue_type_script_setup_true_lang-DajtiogQ.js";import{g as H}from"./index-Cwb307Pz.js";import{N as K,C as W}from"./consts-CvaDWb4S.js";import{j as X,h as Z,aj as ee,x as ae,Q as te,F as le,k as re,f as ie,ak as se,i as oe}from"./form-designer-DHHJWkD5.js";import{l as ue,r as m,j as de,e as me,b as ne,A as _,q as y,B as s,J as r,C as pe,u as l,m as ve,I as fe,$ as ce,G as ye}from"./form-create-_84fGzaM.js";import"./index-hV7105lN.js";import"./Dialog.vue_vue_type_style_index_0_lang-bMayE4GC.js";import"./tree-COGD3qag.js";import"./index-CRqoysqb.js";import"./index-Bix5n4IG.js";import"./formatTime-BGPGB_ys.js";import"./index-C6FuNdKy.js";const ge=ue({name:"BpmOALeaveCreate",__name:"create",setup(_e){const v=I(),{delView:U}=Q(),{push:E,currentRoute:N}=L(),{query:T}=M(),p=m(!1),i=m({type:void 0,reason:void 0,startTime:void 0,endTime:void 0}),k=de({type:[{required:!0,message:"\u8BF7\u5047\u7C7B\u578B\u4E0D\u80FD\u4E3A\u7A7A",trigger:"blur"}],reason:[{required:!0,message:"\u8BF7\u5047\u539F\u56E0\u4E0D\u80FD\u4E3A\u7A7A",trigger:"change"}],startTime:[{required:!0,message:"\u8BF7\u5047\u5F00\u59CB\u65F6\u95F4\u4E0D\u80FD\u4E3A\u7A7A",trigger:"change"}],endTime:[{required:!0,message:"\u8BF7\u5047\u7ED3\u675F\u65F6\u95F4\u4E0D\u80FD\u4E3A\u7A7A",trigger:"change"}]}),g=m(),n=m([]),d=m({}),c=m({}),b=m([]),h=m(""),x=async()=>{var t,e;if(g&&await g.value.validate()){if(((t=n.value)==null?void 0:t.length)>0){for(const a of n.value)if(Array.isArray(d.value[a.id])&&d.value[a.id].length===0)return v.warning(`\u8BF7\u9009\u62E9${a.name}\u7684\u5BA1\u6279\u4EBA`)}p.value=!0;try{const a={...i.value};((e=n.value)==null?void 0:e.length)>0&&(a.startUserSelectAssignees=d.value),await F(a),v.success("\u53D1\u8D77\u6210\u529F"),U(l(N)),await E({name:"BpmOALeave"})}finally{p.value=!1}}},V=async()=>{var t,e;try{const a=await H({processDefinitionId:h.value,activityId:K.START_USER_NODE_ID,processVariablesStr:JSON.stringify({day:R()})});if(!a)return void v.error("\u67E5\u8BE2\u4E0D\u5230\u5BA1\u6279\u8BE6\u60C5\u4FE1\u606F\uFF01");if(b.value=a.activityNodes,n.value=(t=a.activityNodes)==null?void 0:t.filter(u=>W.START_USER_SELECT===u.candidateStrategy),((e=n.value)==null?void 0:e.length)>0)for(const u of n.value)c.value[u.id]&&c.value[u.id].length>0?d.value[u.id]=c.value[u.id]:d.value[u.id]=[]}finally{}},O=(t,e)=>{d.value[t]=e==null?void 0:e.map(a=>a.id)},R=()=>{const t=Math.abs(Number(i.value.endTime)-Number(i.value.startTime));return Math.floor(t/864e5)};return me(async()=>{const t=await Y(void 0,"oa_leave");t?(h.value=t.id,n.value=t.startUserSelectTasks,T.id&&await(async e=>{try{p.value=!0;const a=await G(e);if(!a)return void v.error("\u91CD\u65B0\u53D1\u8D77\u8BF7\u5047\u5931\u8D25\uFF0C\u539F\u56E0\uFF1A\u8BF7\u5047\u6570\u636E\u4E0D\u5B58\u5728");i.value={type:a.type,reason:a.reason,startTime:a.startTime,endTime:a.endTime}}finally{p.value=!1}})(Number(T.id)),await V()):v.error("OA \u8BF7\u5047\u7684\u6D41\u7A0B\u6A21\u578B\u672A\u914D\u7F6E\uFF0C\u8BF7\u68C0\u67E5\uFF01")}),ne(i.value,(t,e)=>{e&&t&&Object.keys(t).length>0&&(c.value=d.value,d.value={},V())},{immediate:!0}),(t,e)=>{const a=te,u=ae,f=ee,w=le,q=re,C=ie,B=Z,A=$,S=X,j=oe,D=se;return y(),_(j,{gutter:20},{default:s(()=>[r(S,{span:16},{default:s(()=>[r(A,{title:"\u7533\u8BF7\u4FE1\u606F"},{default:s(()=>[pe((y(),_(B,{ref_key:"formRef",ref:g,model:l(i),rules:l(k),"label-width":"80px"},{default:s(()=>[r(f,{label:"\u8BF7\u5047\u7C7B\u578B",prop:"type"},{default:s(()=>[r(u,{modelValue:l(i).type,"onUpdate:modelValue":e[0]||(e[0]=o=>l(i).type=o),clearable:"",placeholder:"\u8BF7\u9009\u62E9\u8BF7\u5047\u7C7B\u578B"},{default:s(()=>[(y(!0),ve(fe,null,ce(l(J)(l(P).BPM_OA_LEAVE_TYPE),o=>(y(),_(a,{key:o.value,label:o.label,value:o.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),r(f,{label:"\u5F00\u59CB\u65F6\u95F4",prop:"startTime"},{default:s(()=>[r(w,{modelValue:l(i).startTime,"onUpdate:modelValue":e[1]||(e[1]=o=>l(i).startTime=o),clearable:"",placeholder:"\u8BF7\u9009\u62E9\u5F00\u59CB\u65F6\u95F4",type:"datetime","value-format":"x"},null,8,["modelValue"])]),_:1}),r(f,{label:"\u7ED3\u675F\u65F6\u95F4",prop:"endTime"},{default:s(()=>[r(w,{modelValue:l(i).endTime,"onUpdate:modelValue":e[2]||(e[2]=o=>l(i).endTime=o),clearable:"",placeholder:"\u8BF7\u9009\u62E9\u7ED3\u675F\u65F6\u95F4",type:"datetime","value-format":"x"},null,8,["modelValue"])]),_:1}),r(f,{label:"\u539F\u56E0",prop:"reason"},{default:s(()=>[r(q,{modelValue:l(i).reason,"onUpdate:modelValue":e[3]||(e[3]=o=>l(i).reason=o),placeholder:"\u8BF7\u8F93\u5165\u8BF7\u5047\u539F\u56E0",type:"textarea"},null,8,["modelValue"])]),_:1}),r(f,null,{default:s(()=>[r(C,{disabled:l(p),type:"primary",onClick:x},{default:s(()=>e[4]||(e[4]=[ye(" \u786E \u5B9A ")])),_:1},8,["disabled"])]),_:1})]),_:1},8,["model","rules"])),[[D,l(p)]])]),_:1})]),_:1}),r(S,{span:8},{default:s(()=>[r(A,{title:"\u5BA1\u6279\u6D41\u7A0B",bodyStyle:{padding:"0 20px 0"}},{default:s(()=>[r(z,{ref:"timelineRef","activity-nodes":l(b),"show-status-icon":!1,onSelectUserConfirm:O},null,8,["activity-nodes"])]),_:1})]),_:1})]),_:1})}}});export{ge as default};
