import{X as P,a as W,d as Z,aL as $,aX as ee,H as k,G as E}from"./index-DzK2S43K.js";import{_ as te}from"./Dialog.vue_vue_type_style_index_0_lang-D3YOFsHs.js";import{_ as ae}from"./Form-qQEgFPgJ.js";import{_ as oe}from"./SpuSelect.vue_vue_type_script_setup_true_lang-CjgUAYxs.js";import{_ as se}from"./SpuAndSkuList.vue_vue_type_script_setup_true_lang-D06QUGwQ.js";import{b as R}from"./formatTime-BGPGB_ys.js";import{r as _}from"./formRules-CLH8W1j7.js";import{u as ie}from"./useCrudSchemas-CD_Sd-Dx.js";import{j as U,l as re,r as n,m as ne,q as M,I as ce,J as c,u as i,h as ue,B as d,C as le,A as de,G as D,n as pe}from"./form-create-_84fGzaM.js";import{b as me}from"./spu-4VnX9xES.js";import{g as fe}from"./index-CI-zC_07.js";import{i as A}from"./constants-C3gLHYOK.js";import{as as G,f as ve,_ as ye,l as ge,ak as Pe,K as L}from"./form-designer-DHHJWkD5.js";const he=U({name:[_],startTime:[_],endTime:[_],discountType:[_]}),Ce=U([{label:"\u6D3B\u52A8\u540D\u79F0",field:"name",isSearch:!0,form:{colProps:{span:24}},table:{width:120}},{label:"\u6D3B\u52A8\u5F00\u59CB\u65F6\u95F4",field:"startTime",formatter:R,isSearch:!0,search:{component:"DatePicker",componentProps:{valueFormat:"YYYY-MM-DD",type:"daterange"}},form:{component:"DatePicker",componentProps:{type:"date",valueFormat:"x"}},table:{width:120}},{label:"\u6D3B\u52A8\u7ED3\u675F\u65F6\u95F4",field:"endTime",formatter:R,isSearch:!0,search:{component:"DatePicker",componentProps:{valueFormat:"YYYY-MM-DD",type:"daterange"}},form:{component:"DatePicker",componentProps:{type:"date",valueFormat:"x"}},table:{width:120}},{label:"\u6D3B\u52A8\u5546\u54C1",field:"spuId",isTable:!0,isSearch:!1,form:{colProps:{span:24}},table:{width:300}},{label:"\u5907\u6CE8",field:"remark",isSearch:!1,form:{component:"Input",componentProps:{type:"textarea",rows:4},colProps:{span:24}},table:{width:300}}]),{allSchemas:we}=ie(Ce),ke=async m=>await P.get({url:"/promotion/discount-activity/page",params:m}),_e=async m=>await P.put({url:"/promotion/discount-activity/close?id="+m}),be=async m=>await P.delete({url:"/promotion/discount-activity/delete?id="+m}),Ie=re({name:"PromotionDiscountActivityForm",__name:"DiscountActivityForm",emits:["success"],setup(m,{expose:J,emit:K}){const{t:b}=W(),I=Z(),f=n(!1),V=n(""),v=n(!1),x=n(""),y=n(),F=n(),T=n(),N=[{name:"productConfig.discountPrice",rule:e=>e>0,message:"\u5546\u54C1\u4F18\u60E0\u91D1\u989D\u4E0D\u80FD\u4E3A 0 \uFF01\uFF01\uFF01"}],S=n([]),h=n([]),C=n([]),X=(e,t)=>{Y(e,t)},Y=async(e,t,a,r)=>{var w;if(C.value.includes(e))return void(r!=="load"&&I.error("\u6570\u636E\u91CD\u590D\u9009\u62E9\uFF01"));C.value.push(e);const u=await me([e]);if(u.length==0)return;const s=u[0],p=t===void 0?s==null?void 0:s.skus:(w=s==null?void 0:s.skus)==null?void 0:w.filter(o=>t.includes(o.id));p==null||p.forEach(o=>{let l={skuId:o.id,spuId:s.id,discountType:1,discountPercent:0,discountPrice:0};if(a!==void 0){const g=a.find(Q=>Q.skuId===o.id);g&&(g.discountPercent=k(g.discountPercent),g.discountPrice=k(g.discountPrice)),l=g||l}o.productConfig=l}),s.skus=p,h.value.push({spuId:s.id,spuDetail:s,propertyList:fe(s)}),S.value.push(s)};J({open:async(e,t)=>{var a;if(f.value=!0,V.value=b("action."+e),x.value=e,await z(),t){v.value=!0;try{const r=await(async u=>await P.get({url:"/promotion/discount-activity/get?id="+u}))(t);for(let u in r.products){const s=r.products[u].spuId;await Y(s,(a=r.products)==null?void 0:a.map(p=>p.skuId),r.products,"load")}y.value.setValues(r)}finally{v.value=!1}}}});const j=K,q=async()=>{if(y&&await y.value.getElFormRef().validate()){v.value=!0;try{const e=L(T.value.getSkuConfigs("productConfig"));e.forEach(a=>{a.discountPercent=E(a.discountPercent),a.discountPrice=E(a.discountPrice)});const t=L(y.value.formModel);t.products=e,x.value==="create"?(await(async a=>await P.post({url:"/promotion/discount-activity/create",data:a}))(t),I.success(b("common.createSuccess"))):(await(async a=>await P.put({url:"/promotion/discount-activity/update",data:a}))(t),I.success(b("common.updateSuccess"))),f.value=!1,j("success")}finally{v.value=!1}}},B=G(e=>{e.productConfig.discountPrice<=0||(e.productConfig.discountType=A.PRICE.type,e.productConfig.discountPercent=$(e.price-ee(e.productConfig.discountPrice),e.price))},200),H=G(e=>{e.productConfig.discountPercent<=0||e.productConfig.discountPercent>=100||(e.productConfig.discountType=A.PERCENT.type,e.productConfig.discountPrice=k(e.price-e.price*(e.productConfig.discountPercent/100||0)))},200),z=async()=>{S.value=[],h.value=[],C.value=[],await pe(),y.value.getElFormRef().resetFields()},O=e=>{C.value.splice(C.value.findIndex(t=>t==e),1),h.value.splice(h.value.findIndex(t=>t.spuId==e),1)};return(e,t)=>{const a=ve,r=ge,u=ye,s=ae,p=te,w=Pe;return M(),ne(ce,null,[c(p,{modelValue:i(f),"onUpdate:modelValue":t[2]||(t[2]=o=>ue(f)?f.value=o:null),title:i(V),width:"65%"},{footer:d(()=>[c(a,{disabled:i(v),type:"primary",onClick:q},{default:d(()=>t[4]||(t[4]=[D("\u786E \u5B9A")])),_:1},8,["disabled"]),c(a,{onClick:t[1]||(t[1]=o=>f.value=!1)},{default:d(()=>t[5]||(t[5]=[D("\u53D6 \u6D88")])),_:1})]),default:d(()=>[le((M(),de(s,{ref_key:"formRef",ref:y,isCol:!0,rules:i(he),schema:i(we).formSchema},{spuId:d(()=>[c(a,{onClick:t[0]||(t[0]=o=>i(F).open())},{default:d(()=>t[3]||(t[3]=[D("\u9009\u62E9\u5546\u54C1")])),_:1}),c(i(se),{ref_key:"spuAndSkuListRef",ref:T,deletable:!0,"rule-config":N,"spu-list":i(S),"spu-property-list-p":i(h),onDelete:O},{default:d(()=>[c(u,{align:"center",label:"\u4F18\u60E0\u91D1\u989D","min-width":"168"},{default:d(({row:o})=>[c(r,{modelValue:o.productConfig.discountPrice,"onUpdate:modelValue":l=>o.productConfig.discountPrice=l,max:parseFloat(i(k)(o.price)),min:0,precision:2,step:.1,class:"w-100%",onChange:l=>i(B)(o)},null,8,["modelValue","onUpdate:modelValue","max","onChange"])]),_:1}),c(u,{align:"center",label:"\u6298\u6263\u767E\u5206\u6BD4(%)","min-width":"168"},{default:d(({row:o})=>[c(r,{modelValue:o.productConfig.discountPercent,"onUpdate:modelValue":l=>o.productConfig.discountPercent=l,max:100,min:0,precision:2,step:.1,class:"w-100%",onChange:l=>i(H)(o)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1})]),_:1},8,["spu-list","spu-property-list-p"])]),_:1},8,["rules","schema"])),[[w,i(v)]])]),_:1},8,["modelValue","title"]),c(i(oe),{ref_key:"spuSelectRef",ref:F,isSelectSku:!0,onConfirm:X},null,512)],64)}}});export{Ie as _,_e as c,be as d,ke as g};
