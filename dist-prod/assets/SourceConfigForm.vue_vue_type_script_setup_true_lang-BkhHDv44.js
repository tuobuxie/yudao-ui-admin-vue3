import"./index-D_TWD7wt.js";import{P as M}from"./index-BpRFJkOM.js";import{D as A}from"./index-lvaXv4aK.js";import{T as Q}from"./index-DxCMWBFB.js";import{k as h,b as $}from"./constants-CaEZMpg0.js";import{h as B,Z as F,_ as G,aj as J,x as Z,Q as z,ak as H,f as K,i as W}from"./form-designer-DHHJWkD5.js";import{l as X,r as v,j as ee,c as ae,e as le,A as c,q as u,u as m,B as d,J as i,m as y,I,$ as w,C as de,E as te,G as C}from"./form-create-_84fGzaM.js";const ie=X({__name:"SourceConfigForm",setup(re,{expose:L}){const p=v([]),x=v([]),P=v([]),V=v(new Map),g=ee({productId:[{required:!0,message:"\u4EA7\u54C1\u4E0D\u80FD\u4E3A\u7A7A",trigger:"change"}],deviceId:[{required:!0,message:"\u8BBE\u5907\u4E0D\u80FD\u4E3A\u7A7A",trigger:"change"}],method:[{required:!0,message:"\u6D88\u606F\u65B9\u6CD5\u4E0D\u80FD\u4E3A\u7A7A",trigger:"change"}]}),k=v(),O=ae(()=>Object.values(h).filter(a=>a.upstream)),b=a=>[h.EVENT_POST.method,h.PROPERTY_POST.method].includes(a.method),U=a=>{if(!a.productId||!b(a))return[];const r=V.value.get(a.productId)||[];let n=[];return a.method===h.EVENT_POST.method?n=r.filter(o=>o.type===$.EVENT):a.method===h.PROPERTY_POST.method&&(n=r.filter(o=>o.type===$.PROPERTY)),n.map(o=>({label:`${o.name} (${o.identifier})`,value:o.identifier}))},R=async()=>{try{x.value=await M.getSimpleProductList()}catch{}},S=async()=>{try{P.value=await A.getSimpleDeviceList()}catch{}},E=async a=>{if(!V.value.has(a))try{const r=await Q.getThingModelList({productId:a});V.value.set(a,r)}catch{}},j=()=>{p.value.push({productId:void 0,deviceId:void 0,method:void 0,identifier:void 0,identifierLoading:!1})};return le(async()=>{await Promise.all([R(),S()])}),L({validate:()=>k.value.validate(),getData:()=>p.value,setData:a=>{p.value=(a||[]).map(r=>({...r,identifierLoading:!1})),a==null||a.forEach(async r=>{r.productId&&b(r)&&await E(r.productId)})}}),(a,r)=>{const n=z,o=Z,_=J,f=G,T=K,q=F,D=W,N=B,Y=H;return u(),c(N,{ref_key:"formRef",ref:k,model:m(p),rules:m(g),"label-width":"0px","inline-message":!0},{default:d(()=>[i(q,{data:m(p),class:"-mt-10px"},{default:d(()=>[i(f,{label:"\u4EA7\u54C1","min-width":"150"},{default:d(({row:l,$index:s})=>[i(_,{prop:`${s}.productId`,rules:m(g).productId,class:"mb-0px!"},{default:d(()=>[i(o,{modelValue:l.productId,"onUpdate:modelValue":e=>l.productId=e,placeholder:"\u8BF7\u9009\u62E9\u4EA7\u54C1",onChange:e=>(async t=>{t.deviceId=0,t.method=void 0,t.identifier=void 0,t.identifierLoading=!1})(l),clearable:"",filterable:"",style:{width:"100%"}},{default:d(()=>[(u(!0),y(I,null,w(m(x),e=>(u(),c(n,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])]),_:2},1032,["prop","rules"])]),_:1}),i(f,{label:"\u8BBE\u5907","min-width":"150"},{default:d(({row:l,$index:s})=>[i(_,{prop:`${s}.deviceId`,rules:m(g).deviceId,class:"mb-0px!"},{default:d(()=>[i(o,{modelValue:l.deviceId,"onUpdate:modelValue":e=>l.deviceId=e,placeholder:"\u8BF7\u9009\u62E9\u8BBE\u5907",clearable:"",filterable:"",style:{width:"100%"}},{default:d(()=>{return[i(n,{label:"\u5168\u90E8\u8BBE\u5907",value:0}),(u(!0),y(I,null,w((e=l.productId,e?P.value.filter(t=>t.productId===e):[]),t=>(u(),c(n,{key:t.id,label:t.deviceName,value:t.id},null,8,["label","value"]))),128))];var e}),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:2},1032,["prop","rules"])]),_:1}),i(f,{label:"\u6D88\u606F","min-width":"150"},{default:d(({row:l,$index:s})=>[i(_,{prop:`${s}.method`,rules:m(g).method,class:"mb-0px!"},{default:d(()=>[i(o,{modelValue:l.method,"onUpdate:modelValue":e=>l.method=e,placeholder:"\u8BF7\u9009\u62E9\u6D88\u606F",onChange:e=>(async t=>{t.identifier=void 0,b(t)&&t.productId&&(t.identifierLoading=!0,await E(t.productId),t.identifierLoading=!1)})(l),clearable:"",filterable:"",style:{width:"100%"}},{default:d(()=>[(u(!0),y(I,null,w(m(O),e=>(u(),c(n,{key:e.method,label:e.name,value:e.method},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])]),_:2},1032,["prop","rules"])]),_:1}),i(f,{label:"\u6807\u8BC6\u7B26","min-width":"200"},{default:d(({row:l,$index:s})=>[i(_,{prop:`${s}.identifier`,class:"mb-0px!"},{default:d(()=>[b(l)?de((u(),c(o,{key:0,modelValue:l.identifier,"onUpdate:modelValue":e=>l.identifier=e,placeholder:"\u8BF7\u9009\u62E9\u6807\u8BC6\u7B26",clearable:"",filterable:"",style:{width:"100%"}},{default:d(()=>[(u(!0),y(I,null,w(U(l),e=>(u(),c(n,{key:e.value,label:e.label,value:e.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])),[[Y,l.identifierLoading]]):te("",!0)]),_:2},1032,["prop"])]),_:1}),i(f,{align:"center",fixed:"right",label:"\u64CD\u4F5C",width:"60"},{default:d(({$index:l})=>[i(T,{onClick:s=>{return e=l,void p.value.splice(e,1);var e},link:"",type:"danger"},{default:d(()=>r[0]||(r[0]=[C("\u2014")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"]),i(D,{justify:"center",class:"mt-3"},{default:d(()=>[i(T,{onClick:j,type:"primary",plain:"",round:""},{default:d(()=>r[1]||(r[1]=[C("+ \u6DFB\u52A0\u6570\u636E\u6E90")])),_:1})]),_:1})]),_:1},8,["model","rules"])}}});export{ie as _};
