import{X as v,a as J,d as K,F as k,G as w}from"./index-D_TWD7wt.js";import{_ as X}from"./Dialog.vue_vue_type_style_index_0_lang-CJT4CHEp.js";import{_ as z}from"./Form-Dwx7HbU_.js";import{b as T}from"./formatTime-BGPGB_ys.js";import{r as P}from"./formRules-DgRLzYxc.js";import{u as H}from"./useCrudSchemas-BIg7AAIF.js";import{j as U,l as W,r as u,m as O,q as R,I as Q,J as s,u as n,h as Z,B as l,C as $,A as ee,G as _,n as ae}from"./form-create-_84fGzaM.js";import{_ as ie}from"./SpuSelect.vue_vue_type_script_setup_true_lang-DY-D0J9w.js";import{_ as re}from"./SpuAndSkuList.vue_vue_type_script_setup_true_lang-CvWP2-Q6.js";import{g as te}from"./index-D9DKyOnS.js";import{b as oe}from"./spu-gjdwZNJW.js";import{f as se,_ as ne,l as le,ak as ce,K as ue}from"./form-designer-DHHJWkD5.js";const me=async y=>await v.get({url:"/promotion/bargain-activity/page",params:y}),pe=async y=>await v.put({url:"/promotion/bargain-activity/close?id="+y}),de=U({name:[P],startTime:[P],endTime:[P],helpMaxCount:[P],bargainCount:[P],singleLimitCount:[P]}),fe=U([{label:"\u780D\u4EF7\u6D3B\u52A8\u540D\u79F0",field:"name",isSearch:!0,isTable:!1,form:{colProps:{span:24}}},{label:"\u6D3B\u52A8\u5F00\u59CB\u65F6\u95F4",field:"startTime",formatter:T,isSearch:!0,search:{component:"DatePicker",componentProps:{valueFormat:"YYYY-MM-DD",type:"daterange"}},form:{component:"DatePicker",componentProps:{type:"date",valueFormat:"x"}},table:{width:120}},{label:"\u6D3B\u52A8\u7ED3\u675F\u65F6\u95F4",field:"endTime",formatter:T,isSearch:!0,search:{component:"DatePicker",componentProps:{valueFormat:"YYYY-MM-DD",type:"daterange"}},form:{component:"DatePicker",componentProps:{type:"date",valueFormat:"x"}},table:{width:120}},{label:"\u780D\u4EF7\u4EBA\u6570",field:"helpMaxCount",isSearch:!1,form:{component:"InputNumber",labelMessage:"\u53C2\u4E0E\u4EBA\u6570\u4E0D\u80FD\u5C11\u4E8E\u4E24\u4EBA",value:2}},{label:"\u6700\u5927\u5E2E\u780D\u6B21\u6570",field:"bargainCount",isSearch:!1,form:{component:"InputNumber",labelMessage:"\u53C2\u4E0E\u4EBA\u6570\u4E0D\u80FD\u5C11\u4E8E\u4E24\u4EBA",value:2}},{label:"\u603B\u9650\u8D2D\u6570\u91CF",field:"totalLimitCount",isSearch:!1,form:{component:"InputNumber",labelMessage:"\u7528\u6237\u6700\u5927\u80FD\u53D1\u8D77\u780D\u4EF7\u7684\u6B21\u6570",value:0}},{label:"\u780D\u4EF7\u7684\u6700\u5C0F\u91D1\u989D",field:"randomMinPrice",isSearch:!1,isTable:!1,form:{component:"InputNumber",componentProps:{min:0,precision:2,step:.1},labelMessage:"\u7528\u6237\u6BCF\u6B21\u780D\u4EF7\u7684\u6700\u5C0F\u91D1\u989D",value:0}},{label:"\u780D\u4EF7\u7684\u6700\u5927\u91D1\u989D",field:"randomMaxPrice",isSearch:!1,isTable:!1,form:{component:"InputNumber",componentProps:{min:0,precision:2,step:.1},labelMessage:"\u7528\u6237\u6BCF\u6B21\u780D\u4EF7\u7684\u6700\u5927\u91D1\u989D",value:0}},{label:"\u780D\u4EF7\u5546\u54C1",field:"spuId",isSearch:!1,form:{colProps:{span:24}}}]),{allSchemas:ge}=H(fe),be=W({name:"PromotionBargainActivityForm",__name:"BargainActivityForm",emits:["success"],setup(y,{expose:E,emit:N}){const{t:C}=J(),I=K(),p=u(!1),S=u(""),d=u(!1),V=u(""),m=u(),x=u(),D=u(),M=u([]),F=u([]),A=[{name:"productConfig.bargainFirstPrice",rule:i=>i>0,message:"\u5546\u54C1\u780D\u4EF7\u8D77\u59CB\u4EF7\u683C\u4E0D\u80FD\u5C0F\u4E8E 0 \uFF01\uFF01\uFF01"},{name:"productConfig.bargainMinPrice",rule:i=>i>=0,message:"\u5546\u54C1\u780D\u4EF7\u5E95\u4EF7\u4E0D\u80FD\u5C0F\u4E8E 0 \uFF01\uFF01\uFF01"},{name:"productConfig.stock",rule:i=>i>=1,message:"\u5546\u54C1\u6D3B\u52A8\u5E93\u5B58\u4E0D\u80FD\u5C0F\u4E8E 1 \uFF01\uFF01\uFF01"}],L=(i,e)=>{m.value.setValues({spuId:i}),Y(i,e)},Y=async(i,e,a)=>{var h;const t=[],f=await oe([i]);if(f.length==0)return;M.value=[];const o=f[0],g=e===void 0?o==null?void 0:o.skus:(h=o==null?void 0:o.skus)==null?void 0:h.filter(r=>e.includes(r.id));g==null||g.forEach(r=>{let c={spuId:o.id,skuId:r.id,bargainFirstPrice:1,bargainMinPrice:1,stock:1};if(a!==void 0){const b=a.find(q=>q.skuId===r.id);b&&(b.bargainFirstPrice=k(b.bargainFirstPrice),b.bargainMinPrice=k(b.bargainMinPrice)),c=b||c}r.productConfig=c}),o.skus=g,t.push({spuId:o.id,spuDetail:o,propertyList:te(o)}),M.value.push(o),F.value=t};E({open:async(i,e)=>{if(p.value=!0,S.value=C("action."+i),V.value=i,await B(),e){d.value=!0;try{const a=await(async t=>await v.get({url:"/promotion/bargain-activity/get?id="+t}))(e);a.randomMinPrice=k(a.randomMinPrice),a.randomMaxPrice=k(a.randomMaxPrice),await Y(a.spuId,[a.skuId],[{spuId:a.spuId,skuId:a.skuId,bargainFirstPrice:a.bargainFirstPrice,bargainMinPrice:a.bargainMinPrice,stock:a.stock}]),m.value.setValues(a)}finally{d.value=!1}}}});const B=async()=>{M.value=[],F.value=[],await ae(),m.value.getElFormRef().resetFields()},G=N,j=async()=>{if(m&&await m.value.getElFormRef().validate()){d.value=!0;try{const i=ue(m.value.formModel),e=D.value.getSkuConfigs("productConfig");e.forEach(t=>{t.bargainFirstPrice=w(t.bargainFirstPrice),t.bargainMinPrice=w(t.bargainMinPrice)}),i.randomMinPrice=w(i.randomMinPrice),i.randomMaxPrice=w(i.randomMaxPrice);const a={...i,...e[0]};V.value==="create"?(await(async t=>await v.post({url:"/promotion/bargain-activity/create",data:t}))(a),I.success(C("common.createSuccess"))):(await(async t=>await v.put({url:"/promotion/bargain-activity/update",data:t}))(a),I.success(C("common.updateSuccess"))),p.value=!1,G("success")}finally{d.value=!1}}};return(i,e)=>{const a=se,t=le,f=ne,o=z,g=X,h=ce;return R(),O(Q,null,[s(g,{modelValue:n(p),"onUpdate:modelValue":e[2]||(e[2]=r=>Z(p)?p.value=r:null),title:n(S),width:"65%"},{footer:l(()=>[s(a,{disabled:n(d),type:"primary",onClick:j},{default:l(()=>e[4]||(e[4]=[_("\u786E \u5B9A")])),_:1},8,["disabled"]),s(a,{onClick:e[1]||(e[1]=r=>p.value=!1)},{default:l(()=>e[5]||(e[5]=[_("\u53D6 \u6D88")])),_:1})]),default:l(()=>[$((R(),ee(o,{ref_key:"formRef",ref:m,"is-col":!0,rules:n(de),schema:n(ge).formSchema,class:"mt-10px"},{spuId:l(()=>[s(a,{onClick:e[0]||(e[0]=r=>n(x).open())},{default:l(()=>e[3]||(e[3]=[_("\u9009\u62E9\u5546\u54C1")])),_:1}),s(n(re),{ref_key:"spuAndSkuListRef",ref:D,"rule-config":A,"spu-list":n(M),"spu-property-list-p":n(F)},{default:l(()=>[s(f,{align:"center",label:"\u780D\u4EF7\u8D77\u59CB\u4EF7\u683C(\u5143)","min-width":"168"},{default:l(({row:r})=>[s(t,{modelValue:r.productConfig.bargainFirstPrice,"onUpdate:modelValue":c=>r.productConfig.bargainFirstPrice=c,min:0,precision:2,step:.1,class:"w-100%"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),s(f,{align:"center",label:"\u780D\u4EF7\u5E95\u4EF7(\u5143)","min-width":"168"},{default:l(({row:r})=>[s(t,{modelValue:r.productConfig.bargainMinPrice,"onUpdate:modelValue":c=>r.productConfig.bargainMinPrice=c,min:0,precision:2,step:.1,class:"w-100%"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),s(f,{align:"center",label:"\u6D3B\u52A8\u5E93\u5B58","min-width":"168"},{default:l(({row:r})=>[s(t,{modelValue:r.productConfig.stock,"onUpdate:modelValue":c=>r.productConfig.stock=c,class:"w-100%"},null,8,["modelValue","onUpdate:modelValue"])]),_:1})]),_:1},8,["spu-list","spu-property-list-p"])]),_:1},8,["rules","schema"])),[[h,n(d)]])]),_:1},8,["modelValue","title"]),s(n(ie),{ref_key:"spuSelectRef",ref:x,isSelectSku:!0,radio:!0,onConfirm:L},null,512)],64)}}});export{be as _,pe as c,me as g};
