import{a as G,d as j,G as q,F as B}from"./index-D_TWD7wt.js";import{_ as J}from"./Dialog.vue_vue_type_style_index_0_lang-CJT4CHEp.js";import{_ as K}from"./Form-Dwx7HbU_.js";import{_ as z}from"./SpuSelect.vue_vue_type_script_setup_true_lang-DY-D0J9w.js";import{_ as H}from"./SpuAndSkuList.vue_vue_type_script_setup_true_lang-CvWP2-Q6.js";import{b as D}from"./formatTime-BGPGB_ys.js";import{S as O}from"./seckillConfig-D8lvNmwO.js";import{r as u}from"./formRules-DgRLzYxc.js";import{u as Q}from"./useCrudSchemas-BIg7AAIF.js";import{j as Y,l as W,r as n,m as X,q as L,I as Z,J as r,u as s,h as $,B as c,C as ee,A as ae,G as P,n as le}from"./form-create-_84fGzaM.js";import{g as oe,c as te,u as se}from"./seckillActivity-C_mHcAUy.js";import{b as ie}from"./spu-gjdwZNJW.js";import{g as re}from"./index-D9DKyOnS.js";import{f as ue,_ as ne,l as ce,ak as me,K as pe}from"./form-designer-DHHJWkD5.js";const de=Y({spuId:[u],name:[u],startTime:[u],endTime:[u],sort:[u],configIds:[u],totalLimitCount:[u],singleLimitCount:[u],totalStock:[u]}),fe=Y([{label:"\u79D2\u6740\u6D3B\u52A8\u540D\u79F0",field:"name",isSearch:!0,form:{colProps:{span:24}},table:{width:120}},{label:"\u6D3B\u52A8\u5F00\u59CB\u65F6\u95F4",field:"startTime",formatter:D,isSearch:!0,search:{component:"DatePicker",componentProps:{valueFormat:"YYYY-MM-DD",type:"daterange"}},form:{component:"DatePicker",componentProps:{type:"date",valueFormat:"x"}},table:{width:120}},{label:"\u6D3B\u52A8\u7ED3\u675F\u65F6\u95F4",field:"endTime",formatter:D,isSearch:!0,search:{component:"DatePicker",componentProps:{valueFormat:"YYYY-MM-DD",type:"daterange"}},form:{component:"DatePicker",componentProps:{type:"date",valueFormat:"x"}},table:{width:120}},{label:"\u79D2\u6740\u65F6\u6BB5",field:"configIds",form:{component:"Select",componentProps:{multiple:!0,optionsAlias:{labelField:"name",valueField:"id"}},api:O.getSimpleSeckillConfigList},table:{width:300}},{label:"\u603B\u9650\u8D2D\u6570\u91CF",field:"totalLimitCount",form:{component:"InputNumber",value:0},table:{width:120}},{label:"\u5355\u6B21\u9650\u591F\u6570\u91CF",field:"singleLimitCount",form:{component:"InputNumber",value:0},table:{width:120}},{label:"\u6392\u5E8F",field:"sort",form:{component:"InputNumber",value:0},table:{width:80}},{label:"\u79D2\u6740\u6D3B\u52A8\u5546\u54C1",field:"spuId",isTable:!0,isSearch:!1,form:{colProps:{span:24}},table:{width:300}},{label:"\u5907\u6CE8",field:"remark",isSearch:!1,form:{component:"Input",componentProps:{type:"textarea",rows:4},colProps:{span:24}},table:{width:300}}]),{allSchemas:ke}=Q(fe),ve=W({name:"PromotionSeckillActivityForm",__name:"SeckillActivityForm",emits:["success"],setup(be,{expose:U,emit:x}){const{t:w}=G(),S=j(),f=n(!1),C=n(""),k=n(!1),_=n(""),m=n(),I=n(),V=n(),A=[{name:"productConfig.stock",rule:a=>a>=1,message:"\u5546\u54C1\u79D2\u6740\u5E93\u5B58\u5FC5\u987B\u5927\u4E8E\u7B49\u4E8E 1 \uFF01\uFF01\uFF01"},{name:"productConfig.seckillPrice",rule:a=>a>=.01,message:"\u5546\u54C1\u79D2\u6740\u4EF7\u683C\u5FC5\u987B\u5927\u4E8E\u7B49\u4E8E 0.01 \uFF01\uFF01\uFF01"}],b=n([]),y=n([]),E=(a,e)=>{m.value.setValues({spuId:a}),F(a,e)},F=async(a,e,t)=>{var g;const i=[],p=await ie([a]);if(p.length==0)return;b.value=[];const o=p[0],v=e===void 0?o==null?void 0:o.skus:(g=o==null?void 0:o.skus)==null?void 0:g.filter(l=>e.includes(l.id));v==null||v.forEach(l=>{let d={skuId:l.id,stock:0,seckillPrice:0};if(t!==void 0){const h=t.find(N=>N.skuId===l.id);h&&(h.seckillPrice=B(h.seckillPrice)),d=h||d}l.productConfig=d}),o.skus=v,i.push({spuId:o.id,spuDetail:o,propertyList:re(o)}),b.value.push(o),y.value=i};U({open:async(a,e)=>{var t;if(f.value=!0,C.value=w("action."+a),_.value=a,await T(),e){k.value=!0;try{const i=await oe(e);await F(i.spuId,(t=i.products)==null?void 0:t.map(p=>p.skuId),i.products),m.value.setValues(i)}finally{k.value=!1}}}});const M=x,R=async()=>{if(m&&await m.value.getElFormRef().validate()){k.value=!0;try{const a=pe(V.value.getSkuConfigs("productConfig"));a.forEach(t=>{t.seckillPrice=q(t.seckillPrice)});const e=m.value.formModel;e.products=a,_.value==="create"?(await te(e),S.success(w("common.createSuccess"))):(await se(e),S.success(w("common.updateSuccess"))),f.value=!1,M("success")}finally{k.value=!1}}},T=async()=>{b.value=[],y.value=[],await le(),m.value.getElFormRef().resetFields()};return(a,e)=>{const t=ue,i=ce,p=ne,o=K,v=J,g=me;return L(),X(Z,null,[r(v,{modelValue:s(f),"onUpdate:modelValue":e[2]||(e[2]=l=>$(f)?f.value=l:null),title:s(C),width:"65%"},{footer:c(()=>[r(t,{disabled:s(k),type:"primary",onClick:R},{default:c(()=>e[4]||(e[4]=[P("\u786E \u5B9A")])),_:1},8,["disabled"]),r(t,{onClick:e[1]||(e[1]=l=>f.value=!1)},{default:c(()=>e[5]||(e[5]=[P("\u53D6 \u6D88")])),_:1})]),default:c(()=>[ee((L(),ae(o,{ref_key:"formRef",ref:m,isCol:!0,rules:s(de),schema:s(ke).formSchema},{spuId:c(()=>[r(t,{onClick:e[0]||(e[0]=l=>s(I).open())},{default:c(()=>e[3]||(e[3]=[P("\u9009\u62E9\u5546\u54C1")])),_:1}),r(s(H),{ref_key:"spuAndSkuListRef",ref:V,"rule-config":A,"spu-list":s(b),"spu-property-list-p":s(y)},{default:c(()=>[r(p,{align:"center",label:"\u79D2\u6740\u5E93\u5B58","min-width":"168"},{default:c(({row:l})=>[r(i,{modelValue:l.productConfig.stock,"onUpdate:modelValue":d=>l.productConfig.stock=d,min:0,class:"w-100%"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),r(p,{align:"center",label:"\u79D2\u6740\u4EF7\u683C(\u5143)","min-width":"168"},{default:c(({row:l})=>[r(i,{modelValue:l.productConfig.seckillPrice,"onUpdate:modelValue":d=>l.productConfig.seckillPrice=d,min:0,precision:2,step:.1,class:"w-100%"},null,8,["modelValue","onUpdate:modelValue"])]),_:1})]),_:1},8,["spu-list","spu-property-list-p"])]),_:1},8,["rules","schema"])),[[g,s(k)]])]),_:1},8,["modelValue","title"]),r(s(z),{ref_key:"spuSelectRef",ref:I,isSelectSku:!0,onConfirm:E},null,512)],64)}}});export{ve as _};
