import{D as z,a as B,d as O,G as j,F as q}from"./index-DmQdxAiK.js";import{_ as J}from"./Dialog.vue_vue_type_style_index_0_lang-C4PMlRRW.js";import{_ as K}from"./Form-Dw15CODS.js";import{g as H,c as Q,u as W}from"./combinationActivity-C4izthnL.js";import{b as T}from"./formatTime-BGPGB_ys.js";import{r as n}from"./formRules-D53teYbH.js";import{u as X}from"./useCrudSchemas-yI1BhohI.js";import{j as V,l as Z,r,m as $,q as M,I as ee,J as u,u as s,h as ae,B as m,C as oe,A as te,G as P,n as ie}from"./form-create-_84fGzaM.js";import{_ as se}from"./SpuSelect.vue_vue_type_script_setup_true_lang-BR4Mh8FR.js";import{_ as le}from"./SpuAndSkuList.vue_vue_type_script_setup_true_lang-BC23xW3J.js";import{g as re}from"./index-B_dyNDp9.js";import{b as ne}from"./spu-BE3uLdh7.js";import{f as ue,_ as me,l as ce,ak as pe,K as R}from"./form-designer-DHHJWkD5.js";const de=V({name:[n],totalLimitCount:[n],singleLimitCount:[n],startTime:[n],endTime:[n],userSize:[n],limitDuration:[n],virtualGroup:[n]}),fe=V([{label:"\u62FC\u56E2\u540D\u79F0",field:"name",isSearch:!0,isTable:!1,form:{colProps:{span:24}}},{label:"\u6D3B\u52A8\u5F00\u59CB\u65F6\u95F4",field:"startTime",formatter:T,isSearch:!0,search:{component:"DatePicker",componentProps:{valueFormat:"YYYY-MM-DD",type:"daterange"}},form:{component:"DatePicker",componentProps:{type:"date",valueFormat:"x"}},table:{width:120}},{label:"\u6D3B\u52A8\u7ED3\u675F\u65F6\u95F4",field:"endTime",formatter:T,isSearch:!0,search:{component:"DatePicker",componentProps:{valueFormat:"YYYY-MM-DD",type:"daterange"}},form:{component:"DatePicker",componentProps:{type:"date",valueFormat:"x"}},table:{width:120}},{label:"\u53C2\u4E0E\u4EBA\u6570",field:"userSize",isSearch:!1,form:{component:"InputNumber",labelMessage:"\u53C2\u4E0E\u4EBA\u6570\u4E0D\u80FD\u5C11\u4E8E\u4E24\u4EBA",value:2}},{label:"\u9650\u5236\u65F6\u957F",field:"limitDuration",isSearch:!1,isTable:!1,form:{component:"InputNumber",labelMessage:"\u9650\u5236\u65F6\u957F(\u5C0F\u65F6)",componentProps:{placeholder:"\u8BF7\u8F93\u5165\u9650\u5236\u65F6\u957F(\u5C0F\u65F6)"}}},{label:"\u603B\u9650\u8D2D\u6570\u91CF",field:"totalLimitCount",isSearch:!1,isTable:!1,form:{component:"InputNumber",value:0}},{label:"\u5355\u6B21\u9650\u8D2D\u6570\u91CF",field:"singleLimitCount",isSearch:!1,isTable:!1,form:{component:"InputNumber",value:0}},{label:"\u865A\u62DF\u6210\u56E2",field:"virtualGroup",dictType:z.INFRA_BOOLEAN_STRING,dictClass:"boolean",isSearch:!0,form:{component:"Radio",value:!1}},{label:"\u62FC\u56E2\u5546\u54C1",field:"spuId",isSearch:!1,form:{colProps:{span:24}}}]),{allSchemas:be}=X(fe),ve=Z({name:"PromotionCombinationActivityForm",__name:"CombinationActivityForm",emits:["success"],setup(he,{expose:Y,emit:L}){const{t:S}=B(),_=O(),p=r(!1),C=r(""),d=r(!1),I=r(""),c=r(),w=r(),D=r(),h=r([]),k=r([]),N=[{name:"productConfig.combinationPrice",rule:o=>o>=.01,message:"\u5546\u54C1\u62FC\u56E2\u4EF7\u683C\u4E0D\u80FD\u5C0F\u4E8E0.01 \uFF01\uFF01\uFF01"}],A=(o,e)=>{c.value.setValues({spuId:o}),F(o,e)},F=async(o,e,t)=>{var y;const l=[],f=await ne([o]);if(f.length==0)return;h.value=[];const a=f[0],b=e===void 0?a==null?void 0:a.skus:(y=a==null?void 0:a.skus)==null?void 0:y.filter(i=>e.includes(i.id));b==null||b.forEach(i=>{let v={spuId:a.id,skuId:i.id,combinationPrice:0};if(t!==void 0){const g=t.find(U=>U.skuId===i.id);g&&(g.combinationPrice=q(g.combinationPrice)),v=g||v}i.productConfig=v}),a.skus=b,l.push({spuId:a.id,spuDetail:a,propertyList:re(a)}),h.value.push(a),k.value=l};Y({open:async(o,e)=>{var t;if(p.value=!0,C.value=S("action."+o),I.value=o,await E(),e){d.value=!0;try{const l=await H(e);await F(l.spuId,(t=l.products)==null?void 0:t.map(f=>f.skuId),l.products),c.value.setValues(l)}finally{d.value=!1}}}});const E=async()=>{h.value=[],k.value=[],await ie(),c.value.getElFormRef().resetFields()},x=L,G=async()=>{if(c&&await c.value.getElFormRef().validate()){d.value=!0;try{const o=R(D.value.getSkuConfigs("productConfig"));o.forEach(t=>{t.combinationPrice=j(t.combinationPrice)});const e=R(c.value.formModel);e.products=o,I.value==="create"?(await Q(e),_.success(S("common.createSuccess"))):(await W(e),_.success(S("common.updateSuccess"))),p.value=!1,x("success")}finally{d.value=!1}}};return(o,e)=>{const t=ue,l=ce,f=me,a=K,b=J,y=pe;return M(),$(ee,null,[u(b,{modelValue:s(p),"onUpdate:modelValue":e[2]||(e[2]=i=>ae(p)?p.value=i:null),title:s(C),width:"65%"},{footer:m(()=>[u(t,{disabled:s(d),type:"primary",onClick:G},{default:m(()=>e[4]||(e[4]=[P("\u786E \u5B9A")])),_:1},8,["disabled"]),u(t,{onClick:e[1]||(e[1]=i=>p.value=!1)},{default:m(()=>e[5]||(e[5]=[P("\u53D6 \u6D88")])),_:1})]),default:m(()=>[oe((M(),te(a,{ref_key:"formRef",ref:c,"is-col":!0,rules:s(de),schema:s(be).formSchema,class:"mt-10px"},{spuId:m(()=>[u(t,{onClick:e[0]||(e[0]=i=>s(w).open())},{default:m(()=>e[3]||(e[3]=[P("\u9009\u62E9\u5546\u54C1")])),_:1}),u(s(le),{ref_key:"spuAndSkuListRef",ref:D,"rule-config":N,"spu-list":s(h),"spu-property-list-p":s(k)},{default:m(()=>[u(f,{align:"center",label:"\u62FC\u56E2\u4EF7\u683C(\u5143)","min-width":"168"},{default:m(({row:i})=>[u(l,{modelValue:i.productConfig.combinationPrice,"onUpdate:modelValue":v=>i.productConfig.combinationPrice=v,min:0,precision:2,step:.1,class:"w-100%"},null,8,["modelValue","onUpdate:modelValue"])]),_:1})]),_:1},8,["spu-list","spu-property-list-p"])]),_:1},8,["rules","schema"])),[[y,s(d)]])]),_:1},8,["modelValue","title"]),u(s(se),{ref_key:"spuSelectRef",ref:w,isSelectSku:!0,onConfirm:A},null,512)],64)}}});export{ve as _};
