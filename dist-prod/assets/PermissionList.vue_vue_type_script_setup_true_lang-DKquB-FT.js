import{d as D,C as F,_ as G,D as J}from"./index-DmQdxAiK.js";import{_ as V}from"./DictTag.vue_vue_type_script_lang-DiMRMEpR.js";import{d as Z}from"./formatTime-BGPGB_ys.js";import{g as j,P as f,d as K,a as Q}from"./index-uUWMlvvc.js";import{_ as H}from"./PermissionForm.vue_vue_type_script_setup_true_lang-CYwTe1_g.js";import{f as X,i as Y,ak as $,_ as ee,Z as ae}from"./form-designer-DHHJWkD5.js";import{l as le,r as n,b as R,m as ie,q as m,I as te,A as y,E as w,C as se,J as t,B as v,u as s,G as I}from"./form-create-_84fGzaM.js";const re=le({name:"CrmPermissionList",__name:"PermissionList",props:{bizType:{},bizId:{},showAction:{type:Boolean}},emits:["quitTeam"],setup(T,{expose:N,emit:U}){const o=D(),u=T,k=n(!0),r=n([]),x=n({ownerUserId:0}),g=F(),h=async()=>{k.value=!0;try{const a=await j({bizType:u.bizType,bizId:u.bizId});r.value=a,r.value.find(e=>e.userId===g.getUser.id&&e.level===f.OWNER)&&(x.value.ownerUserId=g.getUser.id)}finally{k.value=!1}},d=n([]),E=n(),O=a=>{var e;if(a.findIndex(l=>l.level===f.OWNER)!==-1)return o.warning("\u4E0D\u80FD\u9009\u62E9\u8D1F\u8D23\u4EBA\uFF01"),void((e=E.value)==null?void 0:e.clearSelection());d.value=a},z=n(),W=()=>{var a,e,l;((a=d.value)==null?void 0:a.length)!==0?((e=d.value)==null?void 0:e.length)>1?o.warning("\u7F16\u8F91\u56E2\u961F\u6210\u5458\u65F6\u53EA\u80FD\u9009\u62E9\u4E00\u4E2A\uFF01"):(l=z.value)==null||l.open0("update",u.bizType,u.bizId,d.value[0].id,d.value[0].level):o.warning("\u8BF7\u5148\u9009\u62E9\u56E2\u961F\u6210\u5458\u540E\u64CD\u4F5C\uFF01")},P=async()=>{var e,l;if(((e=d.value)==null?void 0:e.length)===0)return void o.warning("\u8BF7\u5148\u9009\u62E9\u56E2\u961F\u6210\u5458\u540E\u64CD\u4F5C\uFF01");await o.delConfirm();const a=(l=d.value)==null?void 0:l.map(i=>i.id);await K(a),o.success("\u79FB\u9664\u56E2\u961F\u6210\u5458\u6210\u529F\uFF01"),await h()},C=()=>{var a;(a=z.value)==null||a.open("create",u.bizType,u.bizId)},p=n(!1),_=n(!1),b=n(!1);R(r,a=>{var e;if(b.value=!1,(a==null?void 0:a.length)>0){b.value=!r.value.some(i=>i.level===f.OWNER),p.value=!1,_.value=!1;const l=(e=g.getUser)==null?void 0:e.id;r.value.filter(i=>i.userId===l).forEach(i=>{i.level===f.OWNER?(p.value=!0,_.value=!0):i.level===f.WRITE&&(_.value=!0)})}else b.value=!0},{immediate:!0}),N({openForm:C,validateOwnerUser:p,validateWrite:_,isPool:b});const S=U,L=async()=>{if(r.value.find(e=>e.userId===g.getUser.id&&e.level===f.OWNER))return void o.warning("\u8D1F\u8D23\u4EBA\u4E0D\u80FD\u9000\u51FA\u56E2\u961F\uFF01");const a=r.value.find(e=>e.userId===g.getUser.id);a&&(await Q(a.id),o.success("\u9000\u51FA\u56E2\u961F\u6210\u5458\u6210\u529F\uFF01"),S("quitTeam"))};return R(()=>u.bizId,a=>{a&&h()},{immediate:!0,deep:!0}),(a,e)=>{const l=G,i=X,q=Y,c=ee,A=V,B=$;return m(),ie(te,null,[a.showAction?(m(),y(q,{key:0,justify:"end"},{default:v(()=>[s(p)?(m(),y(i,{key:0,type:"primary",onClick:C},{default:v(()=>[t(l,{class:"mr-5px",icon:"ep:plus"}),e[0]||(e[0]=I(" \u65B0\u589E "))]),_:1})):w("",!0),s(p)?(m(),y(i,{key:1,onClick:W},{default:v(()=>[t(l,{class:"mr-5px",icon:"ep:edit"}),e[1]||(e[1]=I(" \u7F16\u8F91 "))]),_:1})):w("",!0),s(p)?(m(),y(i,{key:2,onClick:P},{default:v(()=>[t(l,{class:"mr-5px",icon:"ep:delete"}),e[2]||(e[2]=I(" \u79FB\u9664 "))]),_:1})):w("",!0),!s(p)&&s(r).length>0?(m(),y(i,{key:3,type:"danger",onClick:L},{default:v(()=>e[3]||(e[3]=[I(" \u9000\u51FA\u56E2\u961F ")])),_:1})):w("",!0)]),_:1})):w("",!0),se((m(),y(s(ae),{ref_key:"elTableRef",ref:E,data:s(r),"show-overflow-tooltip":!0,stripe:!0,class:"mt-20px",onSelectionChange:O},{default:v(()=>[t(c,{type:"selection",width:"55"}),t(c,{align:"center",label:"\u59D3\u540D",prop:"nickname"}),t(c,{align:"center",label:"\u90E8\u95E8",prop:"deptName"}),t(c,{align:"center",label:"\u5C97\u4F4D",prop:"postNames"}),t(c,{align:"center",label:"\u6743\u9650\u7EA7\u522B",prop:"level"},{default:v(({row:M})=>[t(A,{type:s(J).CRM_PERMISSION_LEVEL,value:M.level},null,8,["type","value"])]),_:1}),t(c,{formatter:s(Z),align:"center",label:"\u52A0\u5165\u65F6\u95F4",prop:"createTime"},null,8,["formatter"])]),_:1},8,["data"])),[[B,s(k)]]),t(H,{ref_key:"formRef",ref:z,onSuccess:h},null,512)],64)}}});export{re as _};
